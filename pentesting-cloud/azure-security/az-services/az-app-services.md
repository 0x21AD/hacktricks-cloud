# Az - App Services

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## App Service Basic Information

Azure App Services enables developers to **build, deploy, and scale web applications, mobile app backends, and APIs seamlessly**. It supports multiple programming languages and integrates with various Azure tools and services for enhanced functionality and management.

Each app runs inside a sandbox but isolation depends upon App Service plans

* Apps in Free and Shared tiers run on shared VMs
* Apps in Standard and Premium tiers run on dedicated VMs

{% hint style="warning" %}
Note that **none** of those isolations **prevents** other common **web vulnerabilities** (such as file upload, or injections). And if a **management identity** is used, it could be able to **esalate privileges to them**.
{% endhint %}

Some interesting features of the Apps Services are:

* **Always On**: If not enabled, the app is unloaded after 20mins without requests. If enabled, the front-end load balancer sends a GET request to the app every 5mins.
* **SSH & Debugging**: It's possible to get a SSH shell inside the app or start a debugging session within the app.
* **Web App + Database**: When creating a new app in the web console, it allows to create a "Web App + Database". If selected a **DB will also be created** (it's possible to choose from SQLAzure, PostgreSQL, MySQL and MongoDB). Moreover, it also allows to create an **Azure Cache for Redis**.
  * This will generate the **env variable** `AZURE_POSTGRESQL_CONNECTIONSTRING` with the URL containing the credentials to access the DB. And the env variable `AZURE_REDIS_CONNECTIONSTRING` with the URL to access the Redis cache, also containing the username and password.
* **Slots**: Slots allow you to deploy multiple instances of your web app (e.g., production, staging, testing) under the same App Service Plan. Slots enable seamless deployments by allowing you to swap environments without downtime, test changes in a staging slot before promoting them to production, and maintain different configurations for each slot. The slots are **completely isolated** from the production environment. Moreover, it's possible to send some **% of the traffic to different slots**.

### Azure Function Apps

Basically **Azure Function apps are a subset of Azure App Service** in the web and if you go to the web console and list all the app services or execute `az webapp list` in az cli you will be able to **see the Function apps also listed here**.

Actually some of the **security related features** App services use (`webapp` in the az cli), are **also used by Function apps**.

## Basic Authentication

When creating a web app (and a Azure function usually) it's possible to indicate if you want Basic Authentication to be enabled. This basically **enables SCM and FTP** for the application so it'll be possible to deploy the application using those technologies.\
Moreover in order to connect to them, Azure provides an **API that allows to get the username, password and URL** to connect to the SCM and FTP servers.

### Webjobs

Azure WebJobs are background tasks that run in the Azure App Service environment. They allow developers to execute scripts or programs alongside their web applications, making it easier to handle asynchronous or time-intensive operations such as file processing, data handling, or scheduled tasks.

This is very interesting from an attackers perspective as an execution inside the webapp would allows to **escalate privileges to the managed identity of the app**.

There are 2 types of web jobs:

* **Continuous**: Runs indefinitely in a loop and it‚Äôs triggered as soon as it‚Äôs created. It‚Äôs ideal for tasks that require constant processing. However, if the app stops running because Always On is disabled and it hasn‚Äôt received a request in the last 20mins, the web job will also stop.
* **Triggered**: Runs on-demand or based on a schedule. It‚Äôs best suited for periodic tasks, such as batch data updates or maintenance routines.

Note that the **logs** of the executions of the webjobs could contain **sensitive information**.

### Enumeration

{% tabs %}
{% tab title="az" %}
{% code overflow="wrap" %}
```bash
# List webapps
az webapp list

## Less information
az webapp list --query "[].{hostName: defaultHostName, state: state, name: name, resourcegroup: resourceGroup}"

# Get info about 1 app
az webapp show --name <name> --resource-group <res-group>

# Get instances of a webapp
az webapp list-instances --name <name> --resource-group <res-group>
## If you have enough perm you can go to the "consoleUrl" and access a shell inside the instance form the web

# Get slots of a webapp
az webapp deployment slot list --name <AppName> --resource-group <ResourceGroupName> --output table
az webapp show --name <AppName> --resource-group <ResourceGroupName> --slot <SlotName>

# Get configured Auth information
az webapp auth show --name <app-name> --resource-group <res-group>

# Get access restrictions of an app
az webapp config access-restriction show --name <name> --resource-group <res-group>

# Remove access restrictions
az webapp config access-restriction remove --resource-group <res-group> -n <name> --rule-name <rule-name>

# Get appsettings of an app
az webapp config appsettings list --name <name> --resource-group <res-group>

# Get backups of a webapp
az webapp config backup list --webapp-name <name> --resource-group <res-group>

# Get backups scheduled for a webapp
az webapp config backup show --webapp-name <name> --resource-group <res-group>  

# Get snapshots
az webapp config snapshot list --resource-group <res-group> -n <name>

# Restore snapshot
az webapp config snapshot restore -g <res-group> -n <name> --time 2018-12-11T23:34:16.8388367

# Get connection strings of a webapp
az webapp config connection-string list --name <name> --resource-group <res-group>

# Get used container by the app
az webapp config container show --name <name> --resource-group <res-group>

# Get storage account configurations of a webapp
az webapp config storage-account list --name <name> --resource-gl_group

# Lets Webjobs
az webapp webjob continuous list --resource-group <res-group> --name <app-name>
az webapp webjob triggered list --resource-group <res-group> --name <app-name>

# Read Webjobs logs with Azure perms (sensitive info?)
az rest --method GET --url ‚Äú<SCM-URL>/vfs/data/jobs/<continuous | triggered>/rev5/job_log.txt"  --resource "https://management.azure.com/"
az rest --method GET --url "https://lol-b5fyaeceh4e9dce0.scm.canadacentral-01.azurewebsites.net/vfs/data/jobs/continuous/rev5/job_log.txt" \
  --resource "https://management.azure.com/"

# Read Webjobs logs with SCM creds (sensitive info?)
curl "<SCM-URL>/vfs/data/jobs/<triggered | continuos>/<webjob-name>/job_log.txt" \
  --user '<username>:<password>' -v
```
{% endcode %}
{% endtab %}

{% tab title="Az Powershell" %}
```powershell
# Get App Services and Function Apps
Get-AzWebApp
# Get only App Services
Get-AzWebApp | ?{$_.Kind -notmatch "functionapp"}
```
{% endtab %}

{% tab title="az get all" %}
{% code overflow="wrap" %}
```bash
#!/bin/bash

# Get all App Service and Function Apps

# Define Azure subscription ID
azure_subscription="your_subscription_id"

# Log in to Azure
az login

# Select Azure subscription
az account set --subscription $azure_subscription

# Get all App Services in the specified subscription
list_app_services=$(az appservice list --query "[].{appServiceName: name, group: resourceGroup}" -o tsv)

# Iterate over each App Service
echo "$list_app_services" | while IFS=$'\t' read -r appServiceName group; do
  # Get the type of the App Service
  service_type=$(az appservice show --name $appServiceName --resource-group $group --query "kind" -o tsv)

  # Check if it is a Function App and print its name
  if [ "$service_type" == "functionapp" ]; then
    echo "Function App Name: $appServiceName"
  fi
done
```
{% endcode %}
{% endtab %}
{% endtabs %}

#### Obtain credentials & get access to the webapp code

```bash
# Get connection strings that could contain credentials (with DBs for example)
az webapp config connection-string list --name <name> --resource-group <res-group>
## Check how to use the DBs connection strings in the SQL page

# Get credentials to access the code and DB credentials if configured.
az webapp deployment list-publishing-profiles --resource-group <res-group> -n <name>


# Get git URL to access the code
az webapp deployment source config-local-git --resource-group <res-group> -n <name>

# Access/Modify the code via git
git clone 'https://<username>:<password>@name.scm.azurewebsites.net/repo-name.git'
## In my case the username was: $nameofthewebapp and the password some random chars
## If you change the code and do a push, the app is automatically redeployed
```



## Privilege Escalation

{% content-ref url="../az-privilege-escalation/az-app-services-privesc.md" %}
[az-app-services-privesc.md](../az-privilege-escalation/az-app-services-privesc.md)
{% endcontent-ref %}

## References

* [https://learn.microsoft.com/en-in/azure/app-service/overview](https://learn.microsoft.com/en-in/azure/app-service/overview)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
